#!/bin/bash

set -e

GITHUB_REPO='https://api.github.com/repos/farmenvy/client'

set_github_status() {
  local status=${1:-pending}

  if [ -n "$GITHUB_ACCESS_TOKEN" ]
  then
    curl -sS "$GITHUB_REPO/statuses/$GIT_COMMIT?access_token=$GITHUB_ACCESS_TOKEN" \
      -H "Content-Type: application/json" \
      -X POST \
      -d "{\"state\": \"$status\", \"description\": \"Jenkins\", \"target_url\": \"$JENKINS_URL/job/$JOB_NAME/$BUILD_NUMBER/console\"}"
  fi
}


title() {
  echo
  echo "===== $* ====="
  echo
}


step() {
  echo "---> $*"
  eval "$*" || abort "$*"
  echo "OK"
}

cleanup() {
  echo '---> pruning docker stuff'
  docker stop $(docker ps -aq) > /dev/null
  docker system prune -f > /dev/null
}

abort() {
  echo
  echo "!!! FAILURE: '$*'"
  title 'setting github status to failure'
  set_github_status 'failure' > /dev/null
  step
  cleanup
  echo "!!! FAILED: '$*'"
  exit 1
}

title 'setting github status to pending'
step set_github_status 'pending' > /dev/null

title 'creating docker image'
DOCKER_TAG=${BUILD_NUMBER:-unspecified}
DOCKER_IMAGE="farmenvy/farmenvy:$DOCKER_TAG"
step docker build -t "$DOCKER_IMAGE" .
#
title 'running static analysis on client'
step docker run --rm -w /home/app/webapp/client $DOCKER_IMAGE \
  ./node_modules/.bin/eslint ./src

title 'running static analysis on API'
step docker run $DOCKER_IMAGE bundle exec rubocop app

title 'creating staging postgres container'
step docker run --rm --name my-postgres -d postgres:latest

title 'running API tests'
step docker run --link my-postgres:postgres \
  -e RAILS_ENV=test \
  $DOCKER_IMAGE /sbin/my_init -- \
  bundle exec rspec spec

title 'setting github status to success'
step set_github_status 'success' > /dev/null

cleanup
