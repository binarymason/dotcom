#!/bin/bash

set -e

GITHUB_REPO='https://api.github.com/repos/farmenvy/client'

set_github_status() {
  local status=${1:-pending}

  curl -sS "$GITHUB_REPO/statuses/$GIT_COMMIT?access_token=$GITHUB_ACCESS_TOKEN" \
    -H "Content-Type: application/json" \
    -X POST \
    -d "{\"state\": \"$status\", \"description\": \"Jenkins\", \"target_url\": \"$JENKINS_URL/job/$JOB_NAME/$BUILD_NUMBER/console\"}"
}


title() {
  echo
  echo "===== $* ====="
  echo
}


step() {
  echo "==> $*"
  eval "$*" || abort "$*"
  echo "OK"
}

in_docker() {
  echo "(in docker container: '$DOCKER_IMAGE')"
  echo "--> $*"
  eval "docker run --rm -v ${PWD}/build:/usr/src/app/build $DOCKER_IMAGE $*"
}

abort() {
  echo "!!! FAILED: '$*'"
  set_github_status 'failure'
  exit 1
}

title 'setting github status to pending'
step set_github_status 'pending' >/dev/null

title 'creating docker image'
DOCKER_TAG=${BUILD_NUMBER:-unspecified}
DOCKER_IMAGE="farmenvy/client:$DOCKER_TAG"
step docker build -t "$DOCKER_IMAGE" .

title 'running static analysis'
step in_docker ./node_modules/.bin/eslint /usr/src/app/src

title 'making production build'
echo "GIT_BRANCH is --> $GIT_BRANCH"
if [[ $GIT_BRANCH == "origin/master" ]]
then
  step in_docker yarn run build

  title 'deploying to s3'
  S3_BUCKET='www.binarymasonry.com'
  step aws s3 sync build "s3://$S3_BUCKET"
  echo "deployed to http://$S3_BUCKET.s3-website-us-east-1.amazonaws.com"
else
  step echo 'not a deployable branch'
fi

title 'removing docker image'
step docker image rm "$DOCKER_IMAGE"

title 'setting github status to success'
step set_github_status 'success' >/dev/null
