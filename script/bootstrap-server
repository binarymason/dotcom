#/bin/bash
set -e

DEPLOY_SSH_DIR='/home/deploy/.ssh'
AUTHORIZED_KEYS_SOURCE='https://raw.githubusercontent.com/farmenvy/dotcom/master/config/server/authorized_keys'
GIT_SERVER_DIR='/home/deploy/farmenvy/dotcom.git'
POST_RECEIVE_SOURCE='https://raw.githubusercontent.com/farmenvy/dotcom/master/config/server/hooks/post-receive'
DEPLOYED_DIR='/home/deploy/current'

echo '=== Activating Firewall (only SSH allowed) ==='
ufw --force reset
ufw allow ssh
ufw --force enable
ufw status

echo '=== Installing Kernel with LXC and AUFS Support ==='
export DEBIAN_FRONTEND=noninteractive
apt-get -qq update
apt-get install -qqy linux-image-extra-`uname -r` git curl jq

echo '=== Verifying Docker Installation ==='
docker run busybox /bin/echo '*** It works! ***'

echo '=== Creating deploy user ==='
adduser --disabled-password --gecos "" deploy
usermod -aG docker deploy


su -- deploy <<EOF
  echo '=== Adding authorized keys ==='

  mkdir -p "$DEPLOY_SSH_DIR"

  curl --silent --fail "$AUTHORIZED_KEYS_SOURCE" > "$DEPLOY_SSH_DIR/authorized_keys"
  chmod 600 "$DEPLOY_SSH_DIR/authorized_keys"
  chmod 700 "$DEPLOY_SSH_DIR"
  cat "$DEPLOY_SSH_DIR/authorized_keys" || exit 1

  echo '=== Initializing farmenvy/dotcom git repo ==='

  mkdir -p "$GIT_SERVER_DIR"
  cd "$GIT_SERVER_DIR" || exit 1
  git init --bare

  echo '=== Installing post-receive hook ==='
  curl --silent --fail \
    "$POST_RECEIVE_SOURCE" > "$GIT_SERVER_DIR/hooks/post-receive"

  chmod +x "$GIT_SERVER_DIR/hooks/post-receive"
  cat "$GIT_SERVER_DIR/hooks/post-receive" || exit 1
  cd ..

  echo "=== Creating $DEPLOYED_DIR ==="
  mkdir -p "$DEPLOYED_DIR"
EOF

echo '*** DONE ***'

