#!/bin/bash

set -e

# ensure we're at project root
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}"  )" && pwd  )"
cd "$DIR/.."

GITHUB_REPO='https://api.github.com/repos/farmenvy/client'
STAGING_IP=$(/bin/bash ./script/determine-staging)

title() {
  echo "---> $*"
}

info() {
  echo "+ $*"
}

set_github_status() {
  RUN_STATUS=${1:-pending}

  if [ -n "$GITHUB_ACCESS_TOKEN" ]
  then
    info "setting github status to '$RUN_STATUS'"
    curl -sS "$GITHUB_REPO/statuses/$GIT_COMMIT?access_token=$GITHUB_ACCESS_TOKEN" \
      -H "Content-Type: application/json" \
      -X POST \
      -d "{\"state\": \"$status\", \"description\": \"Jenkins\", \"target_url\": \"$JENKINS_URL/job/$JOB_NAME/$BUILD_NUMBER/console\"}" \
      > /dev/null
  else
    info 'no github token -- skipping status notification'
  fi
}

cleanup() {
  info '*** performing cleanup ***'
  info 'pruning docker stuff'
  docker-compose stop
  docker system prune -f
  info '*** DONE ***'

  echo "=== $RUN_STATUS ==="
}

trap "cleanup" EXIT

abort() {
  RUN_STATUS=failure
  info "!!! FAILED: '$*'" >&2
  set_github_status 'failure'
  exit 1
}


step() {
  title "$*"
  eval "$*" || abort "$*"
  info "OK"
}

step docker-compose build
step docker-compose run --rm client ./node_modules/.bin/eslint ./src
step docker-compose run --rm api rubocop .
step docker-compose run -e RAILS_ENV=test --rm api rspec spec

title 'deploy'
if [[ "$GIT_BRANCH" =~ .*/master$ ]];
then
  info "Master branch received.  Deploying to staging..."
  step git remote add staging "deploy@$STAGING_IP:farmenvy/dotcom.git"
  step git push staging
  step ./script/healthcheck "$STAGING_IP"
else
  info "Not a deployable branch."
fi

step set_github_status 'success'
